<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name='viewport' content='width=device-width'/>
    <title>Title</title>

    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="js/three.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/stats.min.js"></script>
    <script src="js/Octree.js"></script>
    <script src="js/THREE.MeshLine.js"></script>
    <script src="js/threex.atmospherematerial.js"></script>
    <script src="js/simpleheat.js"></script>

    <script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>

    <script src="js/Globals.js"></script>
    <script src="js/Classes.js"></script>
    <script src="js/Scene.js"></script>


    <link rel="stylesheet" href="material.min.css">
    <script src="material.min.js"></script>
    <link rel="stylesheet" href="main.css">

</head>
<body style="width:100vw;height:100vh;color: #66F0FF;">

<table class="wrapper" id="dMenu" style="width: 100%;height: 100%;background-color: #282828; position: relative; top:0; bottom: 0;left: 0; right: 0; margin: auto;text-align: center" >
    <tbody>
    <tr><td>
    <div id="menu">
            <ul class="mdl-list" >
                <li>
                    <h1>Material design</h1>
                    <h3 id="hConnStatus"><div class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></div></h3>
                </li>

                <li>
                    <ul class="mdl-list" id="gamesList">
                    </ul>
                </li>

                <li class="mdl-list__item">
                    <span  class="mdl-list__item-primary-content" >
                        <div style="width: 100%"><button onclick="enterGame()" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">Start new</button></div>
                    </span>
                </li>
            </ul>
    </div>
    </td></tr>
<tr style="height:0"><td>
    <div class="footer">This work is licensed under the Creative Commons Attribution-NonCommercial-NoDerivs 3.0 Unported License.<br>
        To view a copy of this license, visit <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/">http://creativecommons.org/licenses/by-nc-nd/3.0/</a> or send a letter to Creative Commons, PO Box 1866, Mountain View, CA 94042, USA.</div>
</td>
</tr>
</tbody>
</table>

<!--<div id="dScene" style="display:none; width: 100%;height: 100%; position: absolute; top:0; bottom: 0;left: 0; right: 0; margin: 0;text-align: center" ></div>-->
<div id="Stats-output"></div>

<button id="buttonScreenMode" style="position:absolute; right:30px; top:40px" onclick="toggleFullScreen()" class="mdl-button mdl-js-button mdl-button--accent">[&#8801]</button>
<!--<button id="buttonMenu" style="position:absolute; left:30px; top:40px" onclick="" class="mdl-button mdl-js-button mdl-button--accent">[&#9732]</button>-->
<!--<button id="buttonFire" style="position:absolute; right:30px; bottom:30px" class="mdl-button mdl-js-button mdl-button--fab mdl-button--mini-fab mdl-button--colored">&#8230</button>-->
<p style="color:white; width:100%;position: absolute; bottom: 30px; margin: auto;text-align: center; display:none" id="Score">0:0</p>


<script>

    var sceneDraw = false;

    initConnect();

    CouchDB.getActiveGames( drawGamesList );

    function initConnect() {

        PeerServer.setCallbackOpen( function( id ) {

            document.getElementById('hConnStatus').innerHTML = "connected";
        });

        //PeerServer.setCallbackConnect( drawScene );//возможен дублированный запуск, сейчас решается sceneDraw
        PeerServer.setCallbackReceive( Scene.receiveData );

        //init connection to PeerJS
        PeerServer.open();
    }

    function drawScene( starSystemSeedStr ) {

        if ( sceneDraw )
            return;

        sceneDraw = true;
        document.getElementById('dMenu').style.display = 'none';

        //var dom = document.getElementById('dScene');
        //dom.style.display = 'block';

        Scene.init( starSystemSeedStr || MathHelper.rand( 0, 10000) );
        Scene.paint();
    }

    function drawGamesList( data ) {

        function button( item, i ) {

            var gameId = item.key[ 1 ];
            var gameTime = item.key[ 0 ];
            var newBtn = document.createElement( "li" );

            newBtn.id = "join_" + i;
            //newBtn.href = "javascript:void(0)";
            newBtn.onclick = function () { enterGame( { id: gameId, time: gameTime } ) };
            //newBtn.innerHTML = gameId+'  '+item.value;
            newBtn.innerHTML =
                    '<span class="mdl-list__item-primary-content">' +
                    '<div class="material-icons mdl-badge mdl-badge--overlap" data-badge="'+item.value+'">' + '<a href="#">' + 'join players ' + '</a>' + '</div>' +
                    '</span>';
            newBtn.class = "mdl-list__item";

            return newBtn;
        }

        data && data.rows.forEach( function( item, i ) {

            var li = $("#gamesList").append( button( item, i )).append();
            console.log( item );
        });

    }

    function enterGame( game ) {

        var myId = PeerServer.getMyPeerId();

        game && PeerServer.connect( game.id );

        drawScene( game ? game.id : myId );

        CouchDB.enterGame( myId, game );
    }

    var pfx = ["webkit", "moz", "ms", "o", ""];
    function RunPrefixMethod(obj, method) {

        var p = 0, m, t;
        while (p < pfx.length && !obj[m]) {
            m = method;
            if (pfx[p] == "") {
                m = m.substr(0,1).toLowerCase() + m.substr(1);
            }
            m = pfx[p] + m;
            t = typeof obj[m];
            if (t != "undefined") {
                pfx = [pfx[p]];
                return (t == "function" ? obj[m]() : obj[m]);
            }
            p++;
        }

    }

    function toggleFullScreen() {

        var e = document.documentElement;
        var b = document.getElementById("buttonScreenMode");

        if ( RunPrefixMethod( document, "FullScreen" ) || RunPrefixMethod( document, "IsFullScreen" ) ) {

            RunPrefixMethod( document, "CancelFullScreen" );
            b.innerHTML = "[&#8801]";
        }
        else {

            RunPrefixMethod( e, "RequestFullScreen" );
            b.innerHTML = "]=[";
        }
    }


</script>

</body>

</html>