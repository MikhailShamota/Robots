<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.js"></script>

    <script src="js/three.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/stats.min.js"></script>
    <script src="js/Octree.js"></script>
    <script src="js/THREE.MeshLine.js"></script>

    <script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>

    <script src="js/Globals.js"></script>
    <script src="js/Classes.js"></script>
    <script src="js/Scene.js"></script>

    <link rel="stylesheet" href="material.min.css">
    <script src="material.min.js"></script>
    <!--<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">-->
</head>
<body style="background-color:#888888">

<div class="wrapper" id="dMenu">
    <div id="menu" align="center">
        <div id="main">

            <h1>Material design</h1>
            <h2 id="hConnStatus"><div class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></div></h2>
            <ul class="mdl-list" >

                <ul class="mdl-list" id="gamesList"></ul>
                <li class="mdl-list__item">
                    <span  class="mdl-list__item-primary-content" >
                        <div style="width: 100%"><button onclick="enterGame()" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">New</button></div>
                    </span>
                </li>
            </ul>
        </div>
    </div>
</div>

<div id="dScene" style="display:none" >
    <div id="Stats-output"></div>

    <div id="header">
        <input class="text" type="text" id="myPeerId" value="Your peer id" readonly/>
    </div>
    <div id="footer">Foooooter</div>
</div>

<script>

    var sceneDraw = false;

    initConnect();
    //drawScene();
    CouchDB.getActiveGames( drawGamesList );

    function initConnect() {

        PeerServer.setCallbackOpen( function( id ) {

            document.getElementById('hConnStatus').innerHTML = "connected";
        });

        //PeerServer.setCallbackConnect( drawScene );//возможен дублированный запуск, сейчас решается sceneDraw
        PeerServer.setCallbackReceive( Scene.receiveData );

        //init connection to PeerJS
        PeerServer.open();
    }

    function drawScene( starSystemSeedStr ) {

        if ( sceneDraw )
            return;

        sceneDraw = true;
        document.getElementById('dMenu').style.display = 'none';
        document.getElementById('dScene').style.display = 'block';

        //var myId = PeerServer.getMyPeerId();

        Scene.init( starSystemSeedStr/* || myId.hashCode()*/ );
        Scene.paint();

        //document.getElementById('myPeerId').value = myId;
    }

    function drawGamesList( data ) {

        function button( item, i ) {

            var gameId = item.key[ 1 ];
            var gameTime = item.key[ 0 ];
            var newBtn = document.createElement( "li" );

            newBtn.id = "join_" + i;
            //newBtn.href = "javascript:void(0)";
            newBtn.onclick = function () { enterGame( { id: gameId, time: gameTime } ) };
            //newBtn.innerHTML = gameId+'  '+item.value;
            newBtn.innerHTML =
                    '<span class="mdl-list__item-primary-content">' +
                    '<div class="material-icons mdl-badge mdl-badge--overlap" data-badge="'+item.value+'">' + '<a href="#">' + gameId + '</a>' + '</div>' +
                    '</span>';
            newBtn.class = "mdl-list__item";

            return newBtn;
        }

        data && data.rows.forEach( function( item, i ) {

            var li = $("#gamesList").append( button( item, i )).append();
            console.log( item );
        });

    }

    function enterGame( game ) {

        var myId = PeerServer.getMyPeerId();

        game && PeerServer.connect( game.id );

        drawScene( game ? game.id : myId );

        CouchDB.enterGame( myId, game );
    }

    /*function joinGame( game ) {

        //var id = document.getElementById("inpPeerId").value;
        var myId = PeerServer.getMyPeerId();

        PeerServer.connect( game.id );

        drawScene( game.id );//star system id

        CouchDB.enterGame( myId, game );
    }*/

</script>

</body>

</html>