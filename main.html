<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.js"></script>

    <script src="js/three.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/stats.min.js"></script>
    <script src="js/Octree.js"></script>
    <script src="js/THREE.MeshLine.js"></script>

    <script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>

    <script src="js/Globals.js"></script>
    <script src="js/Classes.js"></script>
    <script src="js/Scene.js"></script>

    <link rel="stylesheet" type="text/css" href="main.css">
</head>
<body>

<div class="wrapper" id="dMenu">
    <div id="menu">
        <div id="main">

            <h1>Space</h1>
            <h2 id="hConnStatus">connecting...</h2>
            <ul>

                <!--<li><input class="input" type="text" id="inpPeerId" value="Enter peer id" onclick="this.value=''"/></li>
                <li><a href="javascript:void(0)" onclick="joinGame()" id="btnJoin" class="button">Join</a></li>-->
                <ul id="gamesList"></ul>
                <li><a href="javascript:void(0)" onclick="newGame()" class="button">New</a></li>
            </ul>
        </div>
    </div>
</div>

<div id="dScene" style="display:none" >
    <div id="Stats-output"></div>

    <div id="header">
        <input class="text" type="text" id="myPeerId" value="Your peer id" readonly/>
    </div>
    <div id="footer">Foooooter</div>
</div>

<script>

    var sceneDraw = false;

    initConnect();
    //drawScene();
    CouchDB.getActiveGames( drawGamesList );

    function initConnect() {

        PeerServer.setCallbackOpen( function( id ) {

            document.getElementById('hConnStatus').innerHTML = "connected";
        });

        //PeerServer.setCallbackConnect( drawScene );//возможен дублированный запуск, сейчас решается sceneDraw
        PeerServer.setCallbackReceive( Scene.receiveData );

        //init connection to PeerJS
        PeerServer.open();
    }

    function drawScene( starSystemSeedId ) {

        if ( sceneDraw )
            return;

        sceneDraw = true;
        document.getElementById('dMenu').style.display = 'none';
        document.getElementById('dScene').style.display = 'block';

        var myId = PeerServer.getMyPeerId();

        Scene.init( starSystemSeedId || myId.hashCode() );
        Scene.paint();

        CouchDB.newGame( myId );

        document.getElementById('myPeerId').value = myId;
    }

    function drawGamesList( data ) {

        function button( item, i ) {

            var newBtn = document.createElement( "a" );

            newBtn.id = "join_" + i;
            newBtn.href = "javascript:void(0)";
            newBtn.onclick = function () { joinGame( item.key ) };
            newBtn.class = "button";
            newBtn.innerHTML = item.key;

            return newBtn;
        }

        data && data.rows.forEach( function( item, i ) {

            var li = $("#gamesList").append("<li></li>").append( button( item, i ) );
            console.log( item );
        });

    }


    function newGame() {

        drawScene();
    }

    function joinGame( id ) {

        //var id = document.getElementById("inpPeerId").value;

        PeerServer.connect( id );

        drawScene( id.hashCode() );//star system id

        CouchDB.joinGame( PeerServer.getMyPeerId(), id );
    }

</script>

</body>

</html>